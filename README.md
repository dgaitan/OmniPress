<p align="center"><a href="https://kindhumans.com" target="_blank"><img src="https://kindhumans.com/wp-content/themes/kindhumans-theme/dist/development/images/kindhumans_vertical_logo.svg" width="200"></a></p>


## About Kinja App

Web Application to manage Kindhumans store features like:

- Memberships
- Dropships
- Subscriptions

## Requirements/Dependences

- PHP 8
- Composer
- Laravel 9
- Redis
- Supervisor
- PostgresSQL

## How to install?

We have two choices to install this project. One is install the requirements/dependences mentioned above in your local machine and run it. Or install it using `Laravel Sail`.
We're going to explain both ways to install it.

But first, is necessary to have composer installed in your local machine. Please follow the documentation of composer to get it installed in your local machine in case you
don't have it installed yet. https://getcomposer.org/doc/00-intro.md#installation-linux-unix-macos

Once you have ready composer, please go to the project root and run `composer install`. It will install the project dependences.

## Pre-requisites
Please copy the `.env.example` file to load our env values. Please run:

```bash
cp .env.example .env
```

### Application Urls.
This app is a client of a kindhumans store which is necessary define some env connection values with our store installed locally. We have a few env variables
to define some values. Look:

```
APP_URL=http://localhost:3030
FRONTEND_URL=http://localhost:3030
ASSET_DOMAIN=https://kindhumans.com # Should no change, but if you want to redirect the asset urls base domain to another domain, change it.
CLIENT_DOMAIN=https://kind.humans # Replace with the local store domain.
```

The `ASSET_DOMAIN` var will be used as the base url for images. We don't store images on this app, normally we have a link of each images to the store connected. By default we
can use kindhumans.com, but if you want to load the images of your local kindhumans store, change it for the url used in your local machine.

The `CLIENT_DOMAIN` is the url of your store in your local machine. 

### Database.
We are using PostgresSQL as our database engine, it means that we need to define this env vars in our .env file.

```
DB_CONNECTION=pgsql
DB_HOST=localhost
DB_PORT=5432
DB_DATABASE=omnipress
DB_USERNAME=postgres
DB_PASSWORD=postgres
```

If you're using Laravel Sail, change the value of `DB_HOST` to `pgsql`.

### Mailer

Is your choice which mailer tool use to see emails but we recommed to use a tool like Mailtrap to see the emails. You will see a env vars already defined like this:

```
MAIL_MAILER=smtp
MAIL_HOST=smtp.mailtrap.io
MAIL_PORT=2525
MAIL_USERNAME=null
MAIL_PASSWORD=null
MAIL_FROM_ADDRESS=noreply@kindhumans.com
MAIL_FROM_NAME="${APP_NAME}"
MAIL_ENCRYPTION=null
```

You should only replace the `MAIL_USERNAME` and `MAIL_PASSWORD` vars with the right values defined by mailtrap.

### WooCommerce API Keys.
We need to define the WooCommerce API Keys to sync the data in our app. So, is necessary you go to your store wp dash and generate a new woo api keys.
To do this, please go to the WP Dash, then WooCommerce > Settings > Advanced > Rest API and then create a new API Keys. **Note:** Please be sure of create the api key with read/write permissions.

Once you created your api keys, you'll see the following vars in your .env file:

```
WOO_CUSTOMER_KEY=add_your_customer_key_here
WOO_CUSTOMER_SECRET=add_yur_customer_secret_here
WOO_CUSTOMER_DOMAIN=http://example.com
```

Replace the values with the right ones.

### Google Auth Login
To login into the app, is necessary generates a google auth key. To do this, please go to the Google Developer Console (https://console.cloud.google.com/apis/dashboard) and create a new api keys.

Steps to create a google api key:

1. Go to https://console.cloud.google.com/apis/dashboard
2. Click on **Credentials** in the left sidebar. (Is the 3rd option)
3. Click on **Create Credentials** then click on **OAuth Client ID**
4. On Application type select **Web Application**
5. Set the App Name
6. Add a new Authorized Javascript origins. Add http://localhost:3030 and http://127.0.0.1:3030
7. Add Authorized redirect URIs and define the next url: `http://localhost:3030/oauth/google/callback`
8. Save it and it will take a few minutes to make effects.

So far, you can add the API Keys generated by Google in the top right inside the form where we defined the step above. Copy the keys and add it to the .env file.
You'll see the variables like this:

```
GOOGLE_CLIENT_ID=578350767445-bblhgo7rfa9cjale719gsb184d8t6j3j.apps.googleusercontent.com
GOOGLE_CLIENT_SECRET=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
GOOGLE_REDIRECT=http://localhost:8000/oauth/google/callback
```

You can try using the current api keys or set the new one.

### Stripe
We use stripe to process payments. So, let's define the api keys:

```
STRIPE_KEY=your-stripe-key
STRIPE_SECRET=your-stripe-secret
CASHIER_CURRENCY=usd
```

Please contact to one of the kindhumans dev team member to get the stripe keys.

### Algolia
We use algolia to index some content and search it easily. Please contact to one of the kindhumans dev team member to get the algolia keys.

## Install with Laravel Sail (Docker).

See: https://laravel.com/docs/9.x/sail

`Laravel Sail` is a package to install a project using Docker. Having said this, the first requirement here is Docker. Once you have installed Docker in your local machine add an alias
to your bash to use `sail` easily. So, please add to your bash:

```bash
alias sail='[ -f sail ] && bash sail || bash vendor/bin/sail'
```

Then load this changes in your termain sourcing it!

```bash
source ~/.zshrc
```

Replace `.zshrc` with the bash profile you're using.

So, now we should be able to use `sail` command in our terminal. Before of install the docker images, let's be sure we are fine with our environment variables.

### Environment

Let's run our first sail command to build our docker image. Please run the following command:

```
$ sail build --no-cache
```

The last command will be run only by the first time. Once the contianer has been installed, let's run:

```
$ sail up
```

It will run the docker image and we should be able to see the site running on http://localhost:3030 with an error. Of course we need to migrate our database.

### Running database migrations:

Every time you need to run new migrations on our database you'll need to run the next command:

``` bash
$ sail artisan migrate
```

Then run:

```bash
$ sail artisan kinja:sync-permissions
```

And then goes to the browser to http://locaslhost:3030 and login with your @kindhumans.com email. You should be able to login to the admin and then you'll need to give super admin permissions
to yourself. So, to do this please go back to  your terminal and run:

```bash
$ sail artisan kinja:become-super-admin youremail@kindhumans.com
```

Of course, replace `youremail@kindhumans.com` with the email you used to login in the admin.

## Adding Kindhumans Data

Of course we need data in our admin to keep it synced with our kindhumans store. So, let's go to our admin with super admin perms and click on `Api Tokens` and let's create a new one
with all the perms. Then copy the API key generated and let's go to the kindhuman store wp dashboard and click on `Tools > Kinja` and set the url of our admin and the api key just 
generated.

To import all the data from out store locally we have two options. Do it via API and via imports. Both works, the difference is in speed. We recommend import the data importing it via csv. So, to do it we should go to the project root of our kindhumans store and run the next wp cli command:

```bash
$ wp kinja export_customers
$ wp kinja export_products
$ wp kinja export_orders
$ wp kinja export_memberships
```

The we should copy those csv files and save it on a `csv/` folder in the root of this project. Then we should import the customers first. 

**Note:** The order of this imports is importante to avoid errors of dependency data.

1. First import customers:
```bash
$ sail artisan kinja:import customers csv/Customers_Kindhumans.csv
```

2. Import Products
```bash
$ sail artisan kinja:import products csv/Products_Kindhumans.csv
```

3. Import Orders
```bash
$ sail artisan kinja:import orders csv/Orders_Kindhumans.csv
```

4. Finally import memberships
```bash
$ sail artisan kinja:import memberships csv/Memberships_Kindhumans.csv
```
